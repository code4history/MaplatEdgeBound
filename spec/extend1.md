# EdgeRuler 拡張計画1

## ターゲットバージョン

0.2.0

## 実現コンポーネント

### Forbid (src/variant/forbid.ts)

* 親クラス Base (src/common/base.ts)の継承クラスとして実装

### Constrain (src/variant/constrain.ts) の再編

* 概要: 一部メソッドの親クラス Base への配置換え
* 目的: 共通の処理は Forbid でも使えるようにするため

## 実現する機能

Delaunator出力を受け取り、不許可エッジ制約付き三角分割を生成

## 利用の仕方

### Constrainと同等のインターフェースで動作

```typescript
import Delaunator from "delaunator";
import FOrbid from "./src/variant/forbid";

const del = Delaunator.from(points); // 初期三角網作成
const fbd = new Forbid(del);         // Forbidインスタンス作成
fbd.forbidAll(forbidEdges);          // 不許可エッジ定義列を追加
const forbidDel = fbd.del;           // 制約結果の三角網受け取り
```

### 基礎アルゴリズムアイデア

#### 初期処理

* まず通常のドロネー三角分割を生成（Constrainと同様）
* 三角網に不許可エッジが存在するかを検出
  * 存在しない場合はそのままで問題ないので、スルー
  * 存在する場合は、削除処理に移る

#### 不許可エッジの処理

* 不許可エッジが三角網のCovexhullの一部である場合、そもそも不許可にできないのでエラー（エラーメッセージ: 無効な幾何形状です）
* 不許可エッジが存在する場合、そのエッジを共有する2つの三角形で構成される四角形を検出
* その四角形が凸四角形か、凹四角形かを確認
  * 凸四角形の場合
    * その四角形の対角線を強制的に入れ替える（フリップ）
  * 凹四角形の場合
    * 四角形の対角線を入れ替えると、位相エラーが発生するため入れ替えない
    * 凹角の頂点をA、そこから反時計回りに各頂点をB、C、Dとおく。この時、不許可エッジはACとなるはずである
    * 凹角Aの反対側の2エッジ（BC, CD）のうち、まず一方（BC）を一時的に消去し、五角形を作成（新たに発生する頂点をEとすると、五角形ABECD）
      * 五角形の対角線のうち、Eから始まり不許可エッジと交わる対角線2本（EA、ED）を結んだ場合、位相エラーが発生しなければ、それを新しいエッジとして採用
      * 位相エラーが発生する場合
        * 現在処理しているのがエッジBCであれば、消去していたエッジBCを一旦解除し、対象をエッジCDに移して同等の五角形に対する処理を実施
        * 現在処理しているのがエッジCDであればエッジCDの消去も一旦戻し、対応不可のエラー（エラーメッセージ: 代替パスが見つかりません）としてエラー
          * この時、verboseオプションが有効であれば、当該不許可エッジの定義と、解消できなかった凹四角形の定義をエラーに出力
  * 新しく生成されたエッジが別の不許可エッジとなっていないかチェック

#### エラー処理

  * フリップができない場合（凹四角形での問題を解消できなかった場合）はエラーとして扱う
  * すべての不許可エッジが除去できない場合もエラーとして扱う
  * エラーメッセージ:
    * NO_ALTERNATIVE_PATH = "代替パスが見つかりません"
    * INVALID_GEOMETRY = "無効な幾何形状です"
    * INTERSECTION_DETECTED = "新しいエッジが既存のエッジと交差します"


### その他要件

#### パフォーマンス要件

* 点数N、不許可エッジ数Mに対して O(N + M log N)の計算量
* メモリ使用量は O(N + M)を超えないこと

#### テスト要件

  * 凸四角形での不許可エッジ除去
  * 凹四角形での代替パス生成
  * 複数の不許可エッジの同時処理
  * エラーケースの適切な処理

#### 制約事項

  * 不許可エッジの代替パスは既存の頂点のみを使用すること
  * 新しく生成されるエッジが別の不許可エッジとならないこと
  * 三角形分割の位相的整合性を維持すること
